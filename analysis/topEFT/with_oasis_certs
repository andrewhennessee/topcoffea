#!/bin/bash

trap cleanup EXIT

cleanup() {
    if [[ -n "${CUSTOM_CERT_LOCATION}" ]]
    then
        rm -rf "${CUSTOM_CERT_LOCATION}"
    fi
}

export OASIS_CERTIFICATES=${OASIS_CERTIFICATES:-x/cvmfs/oasis.opensciencegrid.org/mis/certificates}

if [[ -e "${OASIS_CERTIFICATES}" ]]
then
    echo "Using /cvmfs certificates."
    source /cvmfs/oasis.opensciencegrid.org/osg-software/osg-wn-client/current/el7-x86_64/setup.sh
    unset PYTHONPATH
else
    CUSTOM_CERT_LOCATION=$(mktemp -d -p "$(pwd)" certificates.XXXXXX)
    mkdir -p ${CUSTOM_CERT_LOCATION}

    export X509_CERT_DIR="$CUSTOM_CERT_LOCATION"

    cat > ${X509_CERT_DIR}/ba240aa8.0 <<EOF
-----BEGIN CERTIFICATE-----
MIIF5TCCA82gAwIBAgIRAKJ784Vgmf4VaM2qFHU5jtYwDQYJKoZIhvcNAQENBQAw
gYUxCzAJBgNVBAYTAkdCMRswGQYDVQQIExJHcmVhdGVyIE1hbmNoZXN0ZXIxEDAO
BgNVBAcTB1NhbGZvcmQxGjAYBgNVBAoTEUNPTU9ETyBDQSBMaW1pdGVkMSswKQYD
VQQDEyJDT01PRE8gUlNBIENlcnRpZmljYXRpb24gQXV0aG9yaXR5MB4XDTE0MDEw
MTAwMDAwMFoXDTIzMTIzMTIzNTk1OVowVjELMAkGA1UEBhMCVVMxEjAQBgNVBAoT
CUludGVybmV0MjERMA8GA1UECxMISW5Db21tb24xIDAeBgNVBAMTF0luQ29tbW9u
IElHVEYgU2VydmVyIENBMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA
hc90D6ReKjC10rFRqMRp/+oLUj+/Qqvc71TeoukKtRDKVkzZ31wqimaoLN6phV4y
W525nJo7HuE+P23CFOAYfE3JToqwRwwPkOX6b1T2HWZlQoKQgWuVvAN0X66ti3IP
7yKFfJ+6diAx5lnhMpkO9+FKQN7HmlP8nIQkqhjuLYEKjwlCvo6k8ALHtPz2S8w4
16b5BpCY1l5wNSe3mt71Ol4cYyHmJ398wCW3p9N5BBdJKPgBkDVIANDngh5Q30GE
tuYqWBmcqxTtMuRCpTC661y80Ib2vh6ypnr0s7LwPoKQkHjKZvIKdcGgkiCSAz5k
ljSw6QbfRpb5VoT/0sBHMwIDAQABo4IBfDCCAXgwHwYDVR0jBBgwFoAUu69+Aj36
pvE8hI6t7jiY7NkyMtQwHQYDVR0OBBYEFGHmX8knukD47CgG84kyWlZf4o7RMA4G
A1UdDwEB/wQEAwIBhjASBgNVHRMBAf8ECDAGAQH/AgEAMB0GA1UdJQQWMBQGCCsG
AQUFBwMBBggrBgEFBQcDAjAyBgNVHSAEKzApMA8GDSsGAQQBriMBBAMEAQEwDAYK
KoZIhvdMBQICATAIBgZngQwBAgIwTAYDVR0fBEUwQzBBoD+gPYY7aHR0cDovL2Ny
bC5jb21vZG9jYS5jb20vQ09NT0RPUlNBQ2VydGlmaWNhdGlvbkF1dGhvcml0eS5j
cmwwcQYIKwYBBQUHAQEEZTBjMDsGCCsGAQUFBzAChi9odHRwOi8vY3J0LmNvbW9k
b2NhLmNvbS9DT01PRE9SU0FBZGRUcnVzdENBLmNydDAkBggrBgEFBQcwAYYYaHR0
cDovL29jc3AuY29tb2RvY2EuY29tMA0GCSqGSIb3DQEBDQUAA4ICAQAQFIPT14MV
pGw2cNhWYOmafXfQ2dWfmsxccnBL2+6F3KrZTfK2KKcyp0DsdWaCyJLwRHcxJXL7
Cd1TZFWjqa/agNGsK7B3u8UKZRVwMyvPDtQ8yRzv2qipLNNbSMPvKBZdHpfA5/F6
H15l0tJwdvMAcwt17lW0wzV0VrjSN+t7o5WQdGiF4wL7oX/gc/+9yQf45ijOhAOJ
ayIAWZcD1MnADq+Rhon8NkWk2XpHJ6oFwLNE+ePS9oLRiLAN0LO0EQm0VNXCuCEk
G6nKAFTwHDNSIFDkwdXyAh5UbMK7db+8Ov/aywUOo+8f1SbKkzQDpFjiZ0g1j/16
duwaJQZG0apR35jodALK2kwdyWls4b41Yipv4smLJURTNf9+3i2+YBt6TSFeGuFU
CGe67WEjkPTAGKoTcqDT1YECoGOGHFx6J5rbAtF9u0EDFwuxCkrzT9KV/Pi17CbT
3HqeN2fiBGfqz3m9cwFijTyVyZYMRiC1TTloUXk60fv6TvUJlfQDsX4vZ9IcU7SP
nCfxKXJsZWn9CYx/C5CFGR8u29CRn1IwDv+CpvKz0Z9jEFw+ZVvU9EClj2aN8UiN
7ljJniNnuPDPVhx4wkqRyz05fQS5Txkp5Ljyj/zvngO9alW4tMA0iUgYZRFKQbhq
JfcTEHuGEWV1/air3h4K3++bIqe9p1DeRQ==
-----END CERTIFICATE-----
EOF

    cat > ${X509_CERT_DIR}/ba240aa8.r0 <<EOF
-----BEGIN X509 CRL-----
MIIJvDCCCKQCAQEwDQYJKoZIhvcNAQELBQAwVjELMAkGA1UEBhMCVVMxEjAQBgNV
BAoTCUludGVybmV0MjERMA8GA1UECxMISW5Db21tb24xIDAeBgNVBAMTF0luQ29t
bW9uIElHVEYgU2VydmVyIENBFw0yMTA2MDExODAyMjZaFw0yMTA2MDgxODAyMjZa
MIIH5jAiAhEAvVxfQU9lUkHDzGuRiRJH9xcNMjAwNTA4MTAyNzMzWjAiAhEAvfRr
4HfqzG5mK9MZhNhvJRcNMjAwNjE1MTcwNDMxWjAhAhAr4iNKo7U9cbvWFWYtoxWK
Fw0yMDA2MTUxNzA0NDBaMCICEQC0gwyidq8LxI7FxIFwhyDHFw0yMDA2MjYxNzA2
MDdaMCECEGAT00JcwuERWbZAIvbEjU4XDTIwMDcyODE0NTc1N1owIgIRAI+85/H6
zkRIpPLMEiro9CUXDTIwMDgyNzE2MDc1MFowIgIRAPWRZN4VdyWeV/fEMEefN5IX
DTIwMDkyMTE3NTQzOVowIgIRAJt2YBpfAHU8l+0mEKQ03JgXDTIwMDkyOTE4NTg1
OFowIQIQXoBLu6L//eu/qyCKfVhUrhcNMjAxMDI2MjEwMjI5WjAiAhEA3kSVUYMq
eIG6xAyTcR9LKxcNMjAxMDMwMDAxNTExWjAhAhBUJY+OxWzNf/Sojd0LSammFw0y
MDExMTEyMjQ2MzJaMCECEEvVc+fe/0Hsb5KHrWYE0p4XDTIwMTExMTIyNTA1OVow
IgIRAP95MANduMG5BrfIecON0SEXDTIwMTExMTIyNTEyNFowIgIRAPMe3wpLOwME
gBPFPEflmPIXDTIwMTExMTIyNTIwM1owIQIQKohKukTJOxUssUFVWk77shcNMjAx
MTExMjI1MjM0WjAhAhAjUPiS32w34AHdTTJ5FEJZFw0yMDExMTEyMjU1MThaMCEC
ECqDQ7nBOHFbb9E2BQ+N+FUXDTIwMTExMTIzMjMwMFowIgIRAPWNqUD900ZrJyga
h4PIgNAXDTIwMTIwMjE5NTYxMlowIQIQAMJEGkBG+rIfXhi5vu48gBcNMjAxMjAz
MjIzNTU1WjAiAhEA4pl8QXvTppNhHfDwiqzZjxcNMjAxMjI5MTUxMzE0WjAiAhEA
vs5odXtIYhtiJI0Kf5Dq6RcNMjEwMTA1MjI1MzA4WjAhAhAf7lYMfQkOX0ZaOVp6
2ChQFw0yMTAxMDUyMjU0MDdaMCICEQDAnz1qUqcRLMFQs+SZZYl6Fw0yMTAxMTEy
MDI2MjBaMCICEQDdrUO7+1vGBtq7Ww3hx85KFw0yMTAxMTEyMzAxMTVaMCECEBai
EqmJH/BjEGGSHpEESuIXDTIxMDEyMDE1MDIxOFowIQIQdAMB2uZ/wq0KdKM4jPhx
/xcNMjEwMTI2MTUwMzIzWjAhAhBr3w0PnduEvnAA1QUsV+jMFw0yMTAxMjcxNDQy
MDBaMCECEGvY8GJ3BBiMCfsprpc2ioQXDTIxMDIwMTE3NDQyMFowIQIQMvz9vnlv
UTcZDxWUA6HvOxcNMjEwMjAxMTg0ODQ2WjAiAhEAl92z3pFG1wezmIYTSH2UMBcN
MjEwMjA4MTk1NjI0WjAhAhAdeoYWs3Q6lpNNm5UjF2CDFw0yMTAyMTAxNjQ5MDNa
MCECECjf5UpCjZJgP446/Qrv82sXDTIxMDIxMTAyMTAzMFowIQIQQijusI6V7lrO
9pK+otCsVxcNMjEwMzA1MTYwODA0WjAiAhEAsNv52wwDjln5+hGOwFtkYxcNMjEw
MzA1MTkwMzEzWjAhAhBq7+ZpwcJ96Hr5imCMB0pkFw0yMTAzMDUxOTE0MzFaMCEC
EDeozDCt4yWklNYYsfOXj60XDTIxMDMxNzE5Mzg1M1owIQIQFLmLJf900j6TC31Q
m/a91BcNMjEwMzE3MTkzOTE0WjAiAhEAlTS3g8UGueA2AOQuiUCxDRcNMjEwMzMw
MjAzODUzWjAiAhEArDa1aI3i12l8SAd1dvox5BcNMjEwMzMwMjAzOTQxWjAhAhBP
+Orxz/FFMOGPfhZcp9GRFw0yMTA0MDcxMjU1MTZaMCICEQDQEKfF0IBRaDsxncFy
asOnFw0yMTA0MDgxODM2NTVaMCECEG/wtyTmEHSm7beFHRtDjVIXDTIxMDQyMTE5
MjgzNVowIQIQRbBBg9F7cJ9BydZECNaNhxcNMjEwNDIzMTU0NjE3WjAiAhEApBXs
exjJyDOByCw2i0oMwhcNMjEwNDIzMTU0NzE4WjAhAhBI09yHOXSwVjXOBMbRYYwh
Fw0yMTA0MjkyMDI3MTRaMCICEQDExQBMrIGVsOzdf4dMaVg1Fw0yMTA0MjkyMDI4
MTNaMCECEEtNW8CfePANKE9OAml3eVkXDTIxMDUxMjE5MTAyMlowIgIRAM68I/Ia
1LTNn3ofO06ZGzMXDTIxMDUxMjE5MTAzMlowIQIQTxQ7pNq6Zdc1HWy5Xz0Z3BcN
MjEwNTEzMTQwMzM3WjAiAhEA+A+gpIlYz7e6U6GqraRZqxcNMjEwNTE3MjIzMDM1
WjAiAhEAsTGFvjeSatRJdQkiV9zHHhcNMjEwNTI2MTg1NDE1WjAiAhEApI2gJ9FX
o7f/wXGOYjKxWxcNMjEwNTI2MTkxNzM0WjAhAhBrXBLgfFDbC6gBeUJ+wotIFw0y
MTA1MjYyMjI2MTlaMCICEQCd2SMlJgqBNE88dGKVYyBdFw0yMTA1MjcwNzU4NTha
MCICEQCrLi1tIXlCriQo7vPuz/RxFw0yMTA1MjcyMzMzMDRaMCECED4tWXyPo/LO
aJFWFiBoetcXDTIxMDUyODE1MzUyM1owIQIQHKcAoYnAHLIjHK6TZR5ztRcNMjEw
NTI4MTUzNTI5WqAwMC4wHwYDVR0jBBgwFoAUYeZfySe6QPjsKAbziTJaVl/ijtEw
CwYDVR0UBAQCAgruMA0GCSqGSIb3DQEBCwUAA4IBAQBqCekTOxlupRG+1D37jVeD
82gYax0gAfZmjTTJrlCoTyOheDoGc8bcOjXOQ2417NlhB2MOrhjqxQ/5TTrjfTXC
zkQ7ubdXtnjeOBABd9gqKwEAPDdAKdgeSMfzgxM8Ro2D6E6FAuYKFRatE8b0jUMW
pbC5NawI2QTIWlS4AwQ93tkT2u2954CRcYDCsi69L3IBBsK8m/fXeNHf2p3xhnPM
i95falCxasCBvBsElMfDs1aaL4hWRW21a3LsQtYx4nG8I5Eu/IUGKHWecwYbVXn2
kjIsE++UzC+pNPidcKEXMVFaGYcaXdXmO5oLI7eWToUyZcoieEYroFCUJ6QKGQgO
-----END X509 CRL-----
EOF

    cat > ${X509_CERT_DIR}/InCommon-IGTF-Server-CA.pem <<EOF
-----BEGIN CERTIFICATE-----
MIIF5TCCA82gAwIBAgIRAKJ784Vgmf4VaM2qFHU5jtYwDQYJKoZIhvcNAQENBQAw
gYUxCzAJBgNVBAYTAkdCMRswGQYDVQQIExJHcmVhdGVyIE1hbmNoZXN0ZXIxEDAO
BgNVBAcTB1NhbGZvcmQxGjAYBgNVBAoTEUNPTU9ETyBDQSBMaW1pdGVkMSswKQYD
VQQDEyJDT01PRE8gUlNBIENlcnRpZmljYXRpb24gQXV0aG9yaXR5MB4XDTE0MDEw
MTAwMDAwMFoXDTIzMTIzMTIzNTk1OVowVjELMAkGA1UEBhMCVVMxEjAQBgNVBAoT
CUludGVybmV0MjERMA8GA1UECxMISW5Db21tb24xIDAeBgNVBAMTF0luQ29tbW9u
IElHVEYgU2VydmVyIENBMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA
hc90D6ReKjC10rFRqMRp/+oLUj+/Qqvc71TeoukKtRDKVkzZ31wqimaoLN6phV4y
W525nJo7HuE+P23CFOAYfE3JToqwRwwPkOX6b1T2HWZlQoKQgWuVvAN0X66ti3IP
7yKFfJ+6diAx5lnhMpkO9+FKQN7HmlP8nIQkqhjuLYEKjwlCvo6k8ALHtPz2S8w4
16b5BpCY1l5wNSe3mt71Ol4cYyHmJ398wCW3p9N5BBdJKPgBkDVIANDngh5Q30GE
tuYqWBmcqxTtMuRCpTC661y80Ib2vh6ypnr0s7LwPoKQkHjKZvIKdcGgkiCSAz5k
ljSw6QbfRpb5VoT/0sBHMwIDAQABo4IBfDCCAXgwHwYDVR0jBBgwFoAUu69+Aj36
pvE8hI6t7jiY7NkyMtQwHQYDVR0OBBYEFGHmX8knukD47CgG84kyWlZf4o7RMA4G
A1UdDwEB/wQEAwIBhjASBgNVHRMBAf8ECDAGAQH/AgEAMB0GA1UdJQQWMBQGCCsG
AQUFBwMBBggrBgEFBQcDAjAyBgNVHSAEKzApMA8GDSsGAQQBriMBBAMEAQEwDAYK
KoZIhvdMBQICATAIBgZngQwBAgIwTAYDVR0fBEUwQzBBoD+gPYY7aHR0cDovL2Ny
bC5jb21vZG9jYS5jb20vQ09NT0RPUlNBQ2VydGlmaWNhdGlvbkF1dGhvcml0eS5j
cmwwcQYIKwYBBQUHAQEEZTBjMDsGCCsGAQUFBzAChi9odHRwOi8vY3J0LmNvbW9k
b2NhLmNvbS9DT01PRE9SU0FBZGRUcnVzdENBLmNydDAkBggrBgEFBQcwAYYYaHR0
cDovL29jc3AuY29tb2RvY2EuY29tMA0GCSqGSIb3DQEBDQUAA4ICAQAQFIPT14MV
pGw2cNhWYOmafXfQ2dWfmsxccnBL2+6F3KrZTfK2KKcyp0DsdWaCyJLwRHcxJXL7
Cd1TZFWjqa/agNGsK7B3u8UKZRVwMyvPDtQ8yRzv2qipLNNbSMPvKBZdHpfA5/F6
H15l0tJwdvMAcwt17lW0wzV0VrjSN+t7o5WQdGiF4wL7oX/gc/+9yQf45ijOhAOJ
ayIAWZcD1MnADq+Rhon8NkWk2XpHJ6oFwLNE+ePS9oLRiLAN0LO0EQm0VNXCuCEk
G6nKAFTwHDNSIFDkwdXyAh5UbMK7db+8Ov/aywUOo+8f1SbKkzQDpFjiZ0g1j/16
duwaJQZG0apR35jodALK2kwdyWls4b41Yipv4smLJURTNf9+3i2+YBt6TSFeGuFU
CGe67WEjkPTAGKoTcqDT1YECoGOGHFx6J5rbAtF9u0EDFwuxCkrzT9KV/Pi17CbT
3HqeN2fiBGfqz3m9cwFijTyVyZYMRiC1TTloUXk60fv6TvUJlfQDsX4vZ9IcU7SP
nCfxKXJsZWn9CYx/C5CFGR8u29CRn1IwDv+CpvKz0Z9jEFw+ZVvU9EClj2aN8UiN
7ljJniNnuPDPVhx4wkqRyz05fQS5Txkp5Ljyj/zvngO9alW4tMA0iUgYZRFKQbhq
JfcTEHuGEWV1/air3h4K3++bIqe9p1DeRQ==
-----END CERTIFICATE-----
EOF

    chmod 640 ${CUSTOM_CERT_LOCATION}/???*
fi

#export XRD_LOGLEVEL=Debug
#export XRD_LOGLEVEL=Info
#export HADOOP_ROOT_LOGGER=DEBUG,console

"${@}" 2>&1
status=$?

echo exit status from certs wrapper: $status


exit $status

